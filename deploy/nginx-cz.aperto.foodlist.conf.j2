proxy_cache_path /data/webapps/www_internal/{{ branchVars.filesFolder }}/cache levels=1:2 keys_zone={{ branchVars.nginx.cacheIdentifier }}:10m max_size=1G;

server {
        listen   80;
        server_name {{ branchVars.domains.main }} jidelnicek.apertostudent.cz jidelnilistek.apertostudent.cz;
        charset utf-8;

        include /srv/webutils/nginx-conf/letsencrypt-acme.conf;

        location / {
    		return 302 https://{{ branchVars.domains.main }}$request_uri;
        }
}

{% if sslCertificatePresent %}

server {

        server_name jidelnicek.apertostudent.cz jidelnilistek.apertostudent.cz;

        charset utf-8;
        
        ssl_certificate         /srv/webutils/letsencrypt/certs/jidelnicek.apertostudent.cz/fullchain.pem;
        ssl_certificate_key     /srv/webutils/letsencrypt/certs/jidelnicek.apertostudent.cz/privkey.pem;
        ssl_trusted_certificate /srv/webutils/letsencrypt/certs/jidelnicek.apertostudent.cz/fullchain.pem;
        include /srv/webutils/nginx-conf/ssl.conf;
        
        location / {
    		return 302 https://{{ branchVars.domains.main }}$request_uri;
        }        
}

server {
        server_name {{ branchVars.domains.main }};

        charset utf-8;
        
		access_log /data/log/nginx/{{ branchVars.domains.main.split('.') | reverse | join('.') }}.ssl.access.log goaccess;

        ssl_certificate         /srv/webutils/letsencrypt/certs/{{ branchVars.domains.ssl }}/fullchain.pem;
        ssl_certificate_key     /srv/webutils/letsencrypt/certs/{{ branchVars.domains.ssl }}/privkey.pem;
        ssl_trusted_certificate /srv/webutils/letsencrypt/certs/{{ branchVars.domains.ssl }}/fullchain.pem;
        include /srv/webutils/nginx-conf/ssl.conf;


        #Problems with REST API when using Nginx as reverse proxy
        #http://www.gooddevs.com/rest-api-nginx-proxy-problem/
        underscores_in_headers on;

		location = /favicon.ico {
        	log_not_found off;
			access_log off;
		}


        # Serve static HTML for root path
        location = / {
            root /data/webapps/www/{{ branchVars.filesFolder }};
            try_files /jidelnicek-full.html =404;

            # Cache control for static content
            add_header Cache-Control "public, max-age=300" always;
        }

        # Serve other static foodlist files (historical foodlists, images)
        location ~ ^/(jidelnicek.*\.(html|png|jpg))$ {
            root /data/webapps/www/{{ branchVars.filesFolder }};
            try_files /$1 =404;

            # Cache control for static content
            add_header Cache-Control "public, max-age=3600" always;
        }

        # Proxy to Java app for /nahrat and other app paths
        location /nahrat {
		    include /srv/webutils/nginx-conf/proxy.conf;

		    client_max_body_size 108M;

		    proxy_cookie_path / /;

		    proxy_pass http://127.0.0.1:{{ currentPort }}/nahrat;

		    proxy_connect_timeout      1200;
		    proxy_send_timeout         1200;
		    proxy_read_timeout         1200;
		    send_timeout               1200;

		    # Disable caching for dynamic content
		    proxy_no_cache 1;
		    proxy_cache_bypass 1;
		    add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
		    add_header Pragma "no-cache" always;
		    add_header Expires "0" always;
        }

        # Proxy all other app paths to Java app
        location ~ ^/(wicket|resources|api|login|logout)/ {
		    include /srv/webutils/nginx-conf/proxy.conf;

		    client_max_body_size 108M;

		    proxy_cookie_path / /;

		    proxy_pass http://127.0.0.1:{{ currentPort }}$request_uri;

		    proxy_connect_timeout      1200;
		    proxy_send_timeout         1200;
		    proxy_read_timeout         1200;
		    send_timeout               1200;

		    # Disable caching for dynamic content
		    proxy_no_cache 1;
		    proxy_cache_bypass 1;
		    add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
		    add_header Pragma "no-cache" always;
		    add_header Expires "0" always;
        }

}
{% endif %}


server {
    listen 80;
    server_name {{ branchVars.domains.files }};
    charset utf-8;
	include /srv/webutils/nginx-conf/letsencrypt-acme.conf;

	location / {
		return 302 https://{{ branchVars.domains.files }}$request_uri;
	}
}

{% if sslCertificatePresent %}
server {
    server_name {{ branchVars.domains.files }};

    charset utf-8;
    
    access_log /data/log/nginx/{{ branchVars.domains.files.split('.') | reverse | join('.') }}.ssl.access.log goaccess;
    
    ssl_certificate         /srv/webutils/letsencrypt/certs/{{ branchVars.domains.ssl }}/fullchain.pem;
    ssl_certificate_key     /srv/webutils/letsencrypt/certs/{{ branchVars.domains.ssl }}/privkey.pem;
    ssl_trusted_certificate /srv/webutils/letsencrypt/certs/{{ branchVars.domains.ssl }}/fullchain.pem;
    include /srv/webutils/nginx-conf/ssl.conf;

    root /data/webapps/www/{{ branchVars.filesFolder }};
    
    location ~* ^/img/(resize|crop)/ {
        resolver 8.8.8.8;
        proxy_pass http://{{ branchVars.domains.imagesProxy }}$request_uri;
        proxy_cache {{ branchVars.nginx.cacheIdentifier }};
        proxy_cache_key "$host$document_uri";
        proxy_cache_valid 200 1d;
        proxy_cache_valid any 1m;
        proxy_cache_use_stale error timeout invalid_header updating;
    }

}
{% endif %}


# And a second "server", which will be resize and crop
server {
    listen 80;
    server_name {{ branchVars.domains.imagesProxy }};
 	
 	include /srv/webutils/nginx-conf/letsencrypt-acme.conf;
 	
    root /data/webapps/www/{{ branchVars.filesFolder }};
    index index.php index.html index.htm;

    location = /favicon.ico {
        log_not_found off;
        access_log off;
    }

    location = /robots.txt {
        allow all;
        log_not_found off;
        access_log off;
    }

    location / {
        # This is cool because no php is touched for static content.
        # include the "?$args" part so non-default permalinks doesn't break when using query string
        try_files $uri $uri/;
        proxy_read_timeout 300;
    }


    #Mint images
    location ~* ^/img/resize/([\d\-]+)/([\d\-]+)/(.+)$ {
        alias /data/webapps/www/{{ branchVars.filesFolder }}/$3;
        image_filter resize $1 $2;
        image_filter_buffer 108M;
        image_filter_jpeg_quality 90;
        error_page 415 = /empty;
    }

    location ~* ^/img/crop/([\d\-]+)/([\d\-]+)/(.+)$ {
        alias /data/webapps/www/{{ branchVars.filesFolder }}/$3;
        image_filter crop $1 $2;
        image_filter_buffer 108M;
        image_filter_jpeg_quality 90;
        error_page 415 = /empty;
    }


    location = /empty {
        empty_gif;
    }
}